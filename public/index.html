<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel GCM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Readex+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --background: #f8fafc; --card-bg: #ffffff; --text-primary: #0f172a; --text-secondary: #475569; --border-color: #e2e8f0; --sidebar-bg: #ffffff; --accent-color: #3b82f6; --accent-text: #ffffff; }
        html.dark { --background: #020617; --card-bg: #0f172a; --text-primary: #f8fafc; --text-secondary: #94a3b8; --border-color: #1e293b; --sidebar-bg: #0f172a; --accent-color: #60a5fa; --accent-text: #0f172a; }
        body { font-family: 'Readex Pro', sans-serif; background-color: var(--background); color: var(--text-primary); }
        .page-fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .nav-link.active { background-color: var(--accent-color) !important; color: var(--accent-text) !important; font-weight: 600; }
        .modal-backdrop { background-color: rgba(2, 6, 23, 0.7); backdrop-filter: blur(4px); }
        input, select { color: var(--text-primary); }
        .quick-filter-btn.active { background-color: var(--accent-color); color: var(--accent-text); }
        .tab-btn.active { color: var(--accent-color); border-color: var(--accent-color); }
        .heatmap-cell { transition: background-color 0.2s; }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
    </style>
</head>
<body class="min-h-screen antialiased">
    <div id="app-root"></div>
    <div id="modal-root"></div>
    <div id="toast-root" class="fixed top-5 right-5 z-[100] space-y-2"></div>

    <script>
        class GcmPanelApp {
            constructor(rootNode) {
                this.root = rootNode;
                this.modalRoot = document.getElementById('modal-root');
                this.toastRoot = document.getElementById('toast-root');
                this.state = {
                    user: null,
                    theme: 'dark',
                    timers: {},
                    charts: {},
                    selectedReportUser: null,
                    activeReportFilter: null,
                    rankingFilters: {
                        period: 'weekly',
                        year: new Date().getFullYear(),
                        month: new Date().getMonth(),
                        week: this.getWeekNumber(new Date())
                    },
                    spreadsheetFilters: {
                        status: '',
                        username: ''
                    }
                };

                this.defineApi();
                this.defineTemplates();
                this.init();
            }

            async init() {
                this.state.theme = localStorage.getItem('theme') || 'dark';
                this.updateThemeClass();
                this.state.user = { name: 'Admin', email: 'admin@painel.com' };
                try {
                    await this.renderAppShell();
                    this.checkForAlerts();
                    this.state.timers.alerts = setInterval(() => this.checkForAlerts(), 5 * 60 * 1000);
                } catch (error) {
                    console.error("Erro na inicialização:", error);
                    this.root.innerHTML = `<div class="p-4 text-red-500">Falha ao iniciar a aplicação. Verifique se a API está rodando.</div>`;
                }
            }

            async checkForAlerts() {
                const alertContainer = document.getElementById('alert-container');
                if (!alertContainer) return;

                const res = await this.api.getAlerts();
                if(res.success && res.alerts.length > 0) {
                    alertContainer.innerHTML = this.templates.alertBanner(res.alerts);
                    alertContainer.querySelector('.close-alert-btn')?.addEventListener('click', () => alertContainer.innerHTML = '');
                } else {
                    alertContainer.innerHTML = '';
                }
            }

            async renderAppShell() {
                this.clearTimers();
                this.root.innerHTML = this.templates.appShell(this.state.user);
                this.setupCommonListeners();
                await this.navigateTo(window.location.hash.substring(1) || 'members');
            }

            async navigateTo(page) {
                this.clearTimers();
                if (!window.location.hash.includes(page)) {
                    this.state.selectedReportUser = null;
                }
                const contentContainer = this.root.querySelector('#page-content');
                if (!contentContainer) return;

                window.location.hash = page;
                this.root.querySelector('#page-title').textContent = page.charAt(0).toUpperCase() + page.slice(1);
                this.root.querySelectorAll('#main-nav a').forEach(a => a.classList.toggle('active', a.hash === `#${page}`));

                const pageRenderers = {
                    dashboard: this.renderDashboardPage,
                    ranking: this.renderRankingPage,
                    reports: this.renderReportsPage,
                    spreadsheet: this.renderSpreadsheetPage,
                    members: this.renderMembersPage,
                    settings: this.renderSettingsPage,
                };
                const renderer = pageRenderers[page] || this.renderNotFoundPage;

                await renderer.call(this, contentContainer);
            }

            async renderDashboardPage(container) {
                container.innerHTML = this.templates.loadingDashboard();
                const summary = await this.api.getDashboardSummary();
                if (summary && summary.success) {
                    container.innerHTML = this.templates.dashboardPage(summary, this.formatDuration);
                    this.renderChart('status', summary, '#status-chart');
                    this.renderChart('activity', summary.weeklyActivity, '#activity-chart');
                    this.renderChart('hourly', summary.hourlyActivity, '#hourly-activity-chart');
                    this.renderActivityFeed(summary.activityFeed);
                } else {
                    container.innerHTML = this.templates.errorPage('Falha ao carregar dados do dashboard.');
                }
            }

            formatDuration(ms, detailed = false) {
                 if (isNaN(ms) || ms <= 0) return detailed ? '0h 0m' : '0m';
                const hours = Math.floor(ms / 3600000);
                const minutes = Math.floor((ms % 3600000) / 60000);
                let result = '';
                if (hours > 0) result += `${hours}h `;
                result += `${minutes}m`;
                return result.trim();
            }

            getPeriodDescription(activeFilter, startDate, endDate) {
                const formatDate = (dateString) => {
                    if (!dateString) return '';
                    const [year, month, day] = dateString.split('-');
                    return `${day}/${month}/${year}`;
                };

                switch(activeFilter) {
                    case 'today': return 'de Hoje';
                    case 'week': return 'desta Semana';
                    case 'month': return 'deste Mês';
                    default:
                        if (startDate && endDate) {
                            if (startDate === endDate) return `do dia ${formatDate(startDate)}`;
                            return `de ${formatDate(startDate)} a ${formatDate(endDate)}`;
                        }
                        if (startDate) return `a partir de ${formatDate(startDate)}`;
                        if (endDate) return `até ${formatDate(endDate)}`;
                        return 'de todo o período';
                }
            }

            renderActivityFeed(feedItems) {
                const feedContainer = this.root.querySelector('#activity-feed');
                if (!feedContainer || !feedItems) return;
                feedContainer.innerHTML = feedItems.length > 0
                    ? feedItems.map(item => this.templates.activityFeedItem(item)).join('')
                    : '<p class="text-sm text-text-secondary text-center py-4">Nenhuma atividade recente.</p>';
            }

            async renderRankingPage(container) {
                container.innerHTML = this.templates.rankingPage(this.state.rankingFilters, this.getWeekNumber, this.getWeekDateRange);
                this.updateRankingView();
                this.setupRankingListeners();
            }

            async updateRankingView() {
                const listContainer = this.root.querySelector('#ranking-list-container');
                if (!listContainer) return;
                listContainer.innerHTML = this.templates.loadingRow(3);

                const params = new URLSearchParams(this.state.rankingFilters);
                const res = await this.api.getRanking(params.toString());

                if (res.success) {
                    listContainer.innerHTML = res.ranking.length > 0
                        ? res.ranking.map((item, index) => this.templates.rankingItem(item, index, (duration) => this.formatDuration(duration, true))).join('')
                        : this.templates.emptyRow(3);
                } else {
                    listContainer.innerHTML = this.templates.errorPage('Falha ao carregar ranking.');
                }
            }

            setupRankingListeners() {
                const periodSelect = this.root.querySelector('#ranking-period-select');
                const yearSelect = this.root.querySelector('#ranking-year-select');
                const monthSelect = this.root.querySelector('#ranking-month-select');
                const weekSelect = this.root.querySelector('#ranking-week-select');

                const handleFilterChange = () => {
                    this.state.rankingFilters.period = periodSelect.value;
                    this.state.rankingFilters.year = parseInt(yearSelect.value);
                    if (periodSelect.value === 'monthly') {
                        this.state.rankingFilters.month = parseInt(monthSelect.value);
                    } else {
                        this.state.rankingFilters.week = parseInt(weekSelect.value);
                    }
                    this.renderRankingPage(this.root.querySelector('#page-content'));
                };

                periodSelect.addEventListener('change', handleFilterChange);
                yearSelect.addEventListener('change', handleFilterChange);
                monthSelect.addEventListener('change', handleFilterChange);
                weekSelect.addEventListener('change', handleFilterChange);
            }

            async renderReportsPage(container) {
                container.innerHTML = this.templates.loadingDashboard();

                if (this.state.selectedReportUser) {
                    await this.renderReportForUser(container, this.state.selectedReportUser);
                } else {
                    const usersResponse = await this.api.getUniqueUsers();
                    if (usersResponse.success) {
                        container.innerHTML = this.templates.reportUserListPage(usersResponse.users);
                        container.querySelectorAll('.user-report-link').forEach(link => {
                            link.addEventListener('click', (e) => {
                                e.preventDefault();
                                const userId = e.currentTarget.dataset.userid;
                                const username = e.currentTarget.dataset.username;
                                this.state.selectedReportUser = { userId, username };
                                this.renderReportsPage(container);
                            });
                        });
                    } else {
                        container.innerHTML = this.templates.errorPage('Falha ao carregar lista de usuários.');
                    }
                }
            }

            async renderReportForUser(container, user) {
                container.innerHTML = this.templates.reportsPage(user, this.state.activeReportFilter);

                this.setupReportListeners();
                await this.renderReportTable(false);
            }

            setupReportListeners() {
                this.root.querySelector('#filter-btn').addEventListener('click', () => {
                    this.state.activeReportFilter = null;
                    this.updateQuickFilterButtons();
                    this.renderReportTable(false);
                });
                this.root.querySelector('#export-xlsx-btn').addEventListener('click', () => this.exportReport('xlsx'));
                this.root.querySelector('#export-pdf-btn').addEventListener('click', () => this.exportReport('pdf'));
                this.root.querySelector('#back-to-users-btn').addEventListener('click', () => {
                    this.state.selectedReportUser = null;
                    this.renderReportsPage(this.root.querySelector('#page-content'));
                });

                const todayBtn = this.root.querySelector('#qf-today');
                const weekBtn = this.root.querySelector('#qf-week');
                const monthBtn = this.root.querySelector('#qf-month');
                const startDateInput = this.root.querySelector('#start-date-filter');
                const endDateInput = this.root.querySelector('#end-date-filter');

                const toLocalISOString = (date) => {
                    const year = date.getFullYear();
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const day = date.getDate().toString().padStart(2, '0');
                    return `${year}-${month}-${day}`;
                };

                todayBtn.addEventListener('click', () => {
                    const today = toLocalISOString(new Date());
                    startDateInput.value = today;
                    endDateInput.value = today;
                    this.state.activeReportFilter = 'today';
                    this.updateQuickFilterButtons();
                    this.renderReportTable(false);
                });

                weekBtn.addEventListener('click', () => {
                    const today = new Date();
                    const dayOfWeek = today.getDay();
                    const diffToMonday = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
                    const monday = new Date(today.setDate(diffToMonday));

                    const sunday = new Date(monday);
                    sunday.setDate(monday.getDate() + 6);

                    startDateInput.value = toLocalISOString(monday);
                    endDateInput.value = toLocalISOString(sunday);
                    this.state.activeReportFilter = 'week';
                    this.updateQuickFilterButtons();
                    this.renderReportTable(false);
                });

                monthBtn.addEventListener('click', () => {
                    const today = new Date();
                    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                    const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);

                    startDateInput.value = toLocalISOString(firstDay);
                    endDateInput.value = toLocalISOString(lastDay);
                    this.state.activeReportFilter = 'month';
                    this.updateQuickFilterButtons();
                    this.renderReportTable(false);
                });

                startDateInput.addEventListener('change', () => {
                    this.state.activeReportFilter = null;
                    this.updateQuickFilterButtons();
                });
                endDateInput.addEventListener('change', () => {
                    this.state.activeReportFilter = null;
                    this.updateQuickFilterButtons();
                });
            }

            updateQuickFilterButtons() {
                this.root.querySelectorAll('.quick-filter-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.filter === this.state.activeReportFilter);
                });
            }

            async renderMembersPage(container) {
                container.innerHTML = this.templates.loadingDashboard();
                const response = await this.api.getMembers();

                if (response && response.success) {
                    container.innerHTML = this.templates.membersPage();
                    const accordionContainer = this.root.querySelector('#members-accordion-container');
                    
                    accordionContainer.innerHTML = response.groupedMembers.map(group => 
                        this.templates.battalionAccordion(group, this.isColorDark)
                    ).join('');
                    
                    this.setupMemberPageListeners(response.groupedMembers);
                } else {
                    container.innerHTML = this.templates.errorPage(response.message || 'Falha ao carregar lista de membros.');
                }
            }
            
            setupMemberPageListeners(originalData) {
                this.root.querySelectorAll('.accordion-header').forEach(header => {
                    header.addEventListener('click', () => {
                        const content = header.nextElementSibling;
                        const icon = header.querySelector('i.fa-chevron-down');
                        if (content.style.maxHeight) {
                            content.style.maxHeight = null;
                            icon.style.transform = 'rotate(0deg)';
                        } else {
                            content.style.maxHeight = content.scrollHeight + "px";
                            icon.style.transform = 'rotate(180deg)';
                        }
                    });
                });

                const searchInput = this.root.querySelector('#member-search-input');
                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase().trim();
                    const accordionContainer = this.root.querySelector('#members-accordion-container');
                    
                    if (!searchTerm) {
                        accordionContainer.innerHTML = originalData.map(group => this.templates.battalionAccordion(group, this.isColorDark)).join('');
                        this.setupMemberPageListeners(originalData);
                        return;
                    }

                    const filteredData = originalData.map(group => ({
                        ...group,
                        members: group.members.filter(member => 
                            member.username.toLowerCase().includes(searchTerm) || 
                            member.discordUserId.includes(searchTerm)
                        )
                    })).filter(group => group.members.length > 0);

                    accordionContainer.innerHTML = filteredData.map(group => this.templates.battalionAccordion(group, this.isColorDark)).join('');
                     
                     this.setupMemberPageListeners(originalData);

                     accordionContainer.querySelectorAll('.accordion-header').forEach(header => {
                         const content = header.nextElementSibling;
                         const icon = header.querySelector('i.fa-chevron-down');
                         content.style.maxHeight = content.scrollHeight + "px";
                         icon.style.transform = 'rotate(180deg)';
                     });
                });
            }

            exportReport(format) {
                const filters = {
                    userId: this.state.selectedReportUser.userId,
                    status: this.root.querySelector('#status-filter-select').value,
                    startDate: this.root.querySelector('#start-date-filter').value,
                    endDate: this.root.querySelector('#end-date-filter').value,
                };
                const params = new URLSearchParams(Object.fromEntries(Object.entries(filters).filter(([_, v]) => v != null && v !== '')));
                params.append('format', format);
                window.open(`/api/registros/export?${params.toString()}`, '_blank');
            }

            async renderReportTable(isSpreadsheet = false) {
                const tableId = isSpreadsheet ? '#spreadsheet-table-body' : '#reports-table-body';
                const tableBody = this.root.querySelector(tableId);
                if (!tableBody) return;

                const colspan = isSpreadsheet ? 6 : 5;
                tableBody.innerHTML = this.templates.loadingRow(colspan);

                let filters = {};
                if (isSpreadsheet) {
                    filters = {};
                } else {
                    filters = {
                        userId: this.state.selectedReportUser?.userId,
                        status: this.root.querySelector('#status-filter-select')?.value,
                        startDate: this.root.querySelector('#start-date-filter')?.value,
                        endDate: this.root.querySelector('#end-date-filter')?.value,
                    };
                    if (!filters.userId) {
                        tableBody.innerHTML = this.templates.emptyRow(colspan);
                        return;
                    }
                }

                const data = await this.api.getRegistros(filters);

                if (data && data.success) {
                    let allPontos = data.registros.flatMap(reg => reg.pontos.map(p => ({...p, username: reg.username, userId: reg.userId })));

                    allPontos.sort((a,b) => new Date(b.entrada) - new Date(a.entrada));

                    if (isSpreadsheet) {
                        const { status, username } = this.state.spreadsheetFilters;
                        if (status) {
                            allPontos = allPontos.filter(p => {
                                const isCompleted = !!p.saida;
                                if (status === 'completed') return isCompleted;
                                if (status === 'pending') return !isCompleted;
                                return true;
                            });
                        }
                        if (username) {
                            allPontos = allPontos.filter(p => p.username.toLowerCase().includes(username.toLowerCase()));
                        }
                        allPontos = allPontos.slice(0, 100);
                    }

                    const rowTemplate = isSpreadsheet ? this.templates.spreadsheetRow : this.templates.reportRow;
                    tableBody.innerHTML = allPontos.length > 0 ? allPontos.map(p => rowTemplate(p, this.formatDuration)).join('') : this.templates.emptyRow(colspan);
                    this.setupActionListeners(tableBody);

                    if (!isSpreadsheet) {
                        const totalHoursEl = this.root.querySelector('#report-total-hours');
                        if (totalHoursEl) {
                            const periodDescription = this.getPeriodDescription(this.state.activeReportFilter, filters.startDate, filters.endDate);
                            totalHoursEl.innerHTML = `Tempo Total ${periodDescription}: <span class="text-blue-500 font-bold">${this.formatDuration(data.totalDuration, true)}</span>`;
                            totalHoursEl.style.display = data.registros.length > 0 ? 'block' : 'none';
                        }
                    }
                } else {
                    tableBody.innerHTML = this.templates.emptyRow(colspan);
                }
            }

            async renderSpreadsheetPage(container) {
                container.innerHTML = this.templates.spreadsheetPage(this.state.spreadsheetFilters);
                this.setupSpreadsheetListeners();
                const renderTable = () => this.renderReportTable(true);
                this.state.timers.spreadsheet = setInterval(renderTable, 30000);
                await renderTable();
            }

            setupSpreadsheetListeners() {
                const statusFilter = this.root.querySelector('#spreadsheet-status-filter');
                const userFilter = this.root.querySelector('#spreadsheet-user-filter');

                const applyFilters = () => {
                    this.state.spreadsheetFilters.status = statusFilter.value;
                    this.state.spreadsheetFilters.username = userFilter.value;
                    this.renderReportTable(true);
                };

                statusFilter.addEventListener('change', applyFilters);
                userFilter.addEventListener('input', applyFilters);
            }

            renderSettingsPage(container) {
                container.innerHTML = this.templates.settingsPage();
            }

            renderNotFoundPage(container) {
                container.innerHTML = this.templates.notFoundPage();
            }

            setupCommonListeners() {
                this.root.querySelector('#theme-toggle')?.addEventListener('click', () => this.toggleTheme());
                window.onhashchange = () => this.navigateTo(window.location.hash.substring(1) || 'dashboard');
                this.updateThemeUI();
            }

            setupActionListeners(container) {
                container.querySelectorAll('.force-logout-btn').forEach(btn => btn.addEventListener('click', e => {
                    const username = e.currentTarget.dataset.username;
                    this.renderForceLogoutInfoModal(username);
                }));
                container.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', e => {
                    const ponto = JSON.parse(e.currentTarget.dataset.ponto);
                    this.renderEditModal(ponto);
                }));
                container.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', e => {
                    this.renderDeleteModal(e.currentTarget.dataset.id);
                }));
            }

            toggleTheme() {
                this.state.theme = this.state.theme === 'light' ? 'dark' : 'light';
                localStorage.setItem('theme', this.state.theme);
                this.updateThemeUI();
            }

            updateThemeClass() { document.documentElement.className = this.state.theme; }
            updateThemeUI() {
                this.updateThemeClass();
                const themeIcon = this.root.querySelector('#theme-toggle');
                if(themeIcon) themeIcon.innerHTML = `<i class="fas fa-${this.state.theme === 'light' ? 'moon' : 'sun'} text-xl"></i>`;
            }

            clearTimers() {
                Object.values(this.state.timers).forEach(timer => clearInterval(timer));
                this.state.timers = {};
            }

            getWeekNumber(d) {
                d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
                var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
                var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1)/7);
                return weekNo;
            }

            getWeekDateRange(year, week) {
                const d = new Date(year, 0, 1 + (week - 1) * 7);
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                const monday = new Date(d.setDate(diff));
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);
                const formatDate = (date) => date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                return `${formatDate(monday)} - ${formatDate(sunday)}`;
            }
            
            async renderMemberDetailsModal(userId) {
                const res = await this.api.getMemberDetails(userId);
                if (!res.success) {
                    this.showToast(res.message || 'Falha ao carregar detalhes do membro.', 'error');
                    return;
                }

                this.modalRoot.innerHTML = this.templates.memberDetailsModal(res.member);
                const modal = this.modalRoot.querySelector('.modal-content');

                const setupTab = (tabButton, tabContent) => {
                    tabButton.addEventListener('click', async () => {
                        modal.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                        modal.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
                        tabButton.classList.add('active');
                        tabContent.style.display = 'block';

                        if (tabButton.id === 'stats-tab-btn' && !tabContent.dataset.loaded) {
                            tabContent.innerHTML = `<div class="text-center p-8"><i class="fas fa-spinner fa-spin"></i> Carregando estatísticas...</div>`;
                            const statsRes = await this.api.getMemberStats(userId);
                            if(statsRes.success) {
                                tabContent.innerHTML = this.templates.memberStatsContent(statsRes.stats, this.formatDuration);
                                this.renderChart('monthlyComparison', statsRes.stats, '#monthly-comparison-chart');
                                tabContent.dataset.loaded = "true";
                            } else {
                                tabContent.innerHTML = this.templates.errorPage('Falha ao carregar estatísticas.');
                            }
                        }
                    });
                };

                setupTab(modal.querySelector('#obs-tab-btn'), modal.querySelector('#obs-content'));
                setupTab(modal.querySelector('#stats-tab-btn'), modal.querySelector('#stats-content'));

                this.modalRoot.querySelector('.modal-close-btn').addEventListener('click', () => this.modalRoot.innerHTML = '');
                this.modalRoot.querySelector('#add-observation-form').addEventListener('submit', async e => {
                    e.preventDefault();
                    const form = e.currentTarget;
                    const text = form.observationText.value;
                    const author = this.state.user.name;

                    const addResult = await this.api.addObservation(userId, { text, author });
                    this.showToast(addResult.message, addResult.success ? 'success' : 'error');
                    if (addResult.success) {
                        await this.renderMemberDetailsModal(userId);
                    }
                });

                modal.querySelector('#obs-tab-btn').click();
            }

            renderChart(type, data, selector) {
                const ctx = this.root.querySelector(selector)?.getContext('2d');
                if (!ctx) return;
                
                const chartId = selector.substring(1);
                if (this.state.charts[chartId]) this.state.charts[chartId].destroy();

                const chartColors = { text: this.state.theme === 'dark' ? '#94a3b8' : '#475569', grid: this.state.theme === 'dark' ? '#1e293b' : '#e2e8f0', cardBg: this.state.theme === 'dark' ? '#0f172a' : '#ffffff' };

                let chartConfig;

                if (type === 'status') {
                    chartConfig = { type: 'doughnut', data: { labels: ['Fechados Hoje', 'Pendentes'], datasets: [{ data: [data.closedToday, data.pendingRegisters], backgroundColor: ['#22c55e', '#f59e0b'], borderColor: chartColors.cardBg, borderWidth: 5 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: chartColors.text } } } } };
                } else if (type === 'activity') {
                    const labels = [...Array(7)].map((_, i) => new Date(new Date().setDate(new Date().getDate() - i)).toISOString().slice(0, 10)).reverse();
                    chartConfig = { type: 'line', data: { labels: labels.map(l => new Date(l).toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'})), datasets: [{ label: 'Registros', data: labels.map(l => data[l] || 0), backgroundColor: 'rgba(59, 130, 246, 0.1)', borderColor: '#3b82f6', borderWidth: 2, fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: chartColors.text }, grid: { color: chartColors.grid } }, x: { ticks: { color: chartColors.text }, grid: { display: false } } }, plugins: { legend: { display: false } } } };
                } else if (type === 'hourly') {
                    chartConfig = { type: 'bar', data: { labels: Array.from({length: 24}, (_, i) => `${i.toString().padStart(2, '0')}:00`), datasets: [{ label: 'Registros por Hora', data: data, backgroundColor: 'rgba(96, 165, 250, 0.5)', borderColor: '#60a5fa', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: chartColors.text, stepSize: 1 }, grid: { color: chartColors.grid } }, x: { ticks: { color: chartColors.text }, grid: { display: false } } }, plugins: { legend: { display: false } } } };
                } else if (type === 'monthlyComparison') {
                    chartConfig = { type: 'bar', data: { labels: ['Horas no Mês'], datasets: [{ label: 'Horas do Membro', data: [data.totalHoursThisMonth.toFixed(2)], backgroundColor: '#60a5fa' }, { label: 'Média da Equipe', data: [data.teamAverageHoursThisMonth.toFixed(2)], backgroundColor: '#6b7280' }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true, ticks: { color: chartColors.text, callback: value => `${value}h` }, grid: { color: chartColors.grid } }, y: { ticks: { color: chartColors.text }, grid: { display: false } } }, plugins: { legend: { position: 'bottom', labels: { color: chartColors.text } } } } };
                }
                
                if (chartConfig) {
                    this.state.charts[chartId] = new Chart(ctx, chartConfig);
                }
            }
            
            renderForceLogoutInfoModal(username) {
                this.modalRoot.innerHTML = this.templates.forceLogoutInfoModal(username);
                this.modalRoot.querySelector('.modal-close-btn').addEventListener('click', () => this.modalRoot.innerHTML = '');
            }

            renderEditModal(ponto) {
                this.modalRoot.innerHTML = this.templates.editModal(ponto);
                this.modalRoot.querySelector('.modal-close-btn').addEventListener('click', () => this.modalRoot.innerHTML = '');
                this.modalRoot.querySelector('#edit-form').addEventListener('submit', async e => {
                    e.preventDefault();
                    const form = e.currentTarget;
                    const result = await this.api.updateRegistro(ponto._id, { entrada: form.entrada.value, saida: form.saida.value });
                    this.showToast(result.message, result.success ? 'success' : 'error');
                    if (result.success) {
                        this.modalRoot.innerHTML = '';
                        this.navigateTo(window.location.hash.substring(1));
                    }
                });
            }

            renderDeleteModal(pontoId) {
                this.modalRoot.innerHTML = this.templates.deleteModal();
                this.modalRoot.querySelector('.modal-close-btn').addEventListener('click', () => this.modalRoot.innerHTML = '');
                this.modalRoot.querySelector('#confirm-delete-btn').addEventListener('click', async () => {
                    const result = await this.api.deleteRegistro(pontoId);
                    this.showToast(result.message, result.success ? 'success' : 'error');
                    this.modalRoot.innerHTML = '';
                    if (result.success) {
                        this.navigateTo(window.location.hash.substring(1));
                    }
                });
            }

            showToast(message, type = 'info') {
                const icons = { success: 'fa-check-circle', error: 'fa-times-circle', info: 'fa-info-circle' };
                const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' };
                const toast = document.createElement('div');
                toast.className = `flex items-center w-full max-w-xs p-4 text-white ${colors[type]} rounded-lg shadow-lg page-fade-in`;
                toast.innerHTML = `<div class="text-xl"><i class="fas ${icons[type]}"></i></div><div class="ml-3 text-sm font-medium">${message}</div>`;
                this.toastRoot.appendChild(toast);
                setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 4000);
            }

            isColorDark(hexColor) {
                if (!hexColor || hexColor.length < 4 || hexColor === '#000000') return true;
                let color = (hexColor.charAt(0) === '#') ? hexColor.substring(1, 7) : hexColor;
                if (color.length === 3) {
                    color = color[0] + color[0] + color[1] + color[1] + color[2] + color[2];
                }
                const r = parseInt(color.substring(0, 2), 16);
                const g = parseInt(color.substring(2, 4), 16);
                const b = parseInt(color.substring(4, 6), 16);
                const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
                return luminance < 0.5;
            }

            defineApi() {
                this.api = {
                    fetch: async (endpoint, options = {}) => { try { const res = await fetch(`/api${endpoint}`, options); return res.json(); } catch (err) { return { success: false, message: 'Erro de rede.' }; } },
                    getDashboardSummary: () => this.api.fetch('/dashboard/summary'),
                    getRanking: (params) => this.api.fetch(`/ranking?${params}`),
                    getRegistros: (filters = {}) => { const params = new URLSearchParams(Object.fromEntries(Object.entries(filters).filter(([_, v]) => v != null && v !== ''))); return this.api.fetch(`/registros?${params}`); },
                    getUniqueUsers: () => this.api.fetch('/unique-users'),
                    getAlerts: () => this.api.fetch('/alerts'),
                    getMembers: () => this.api.fetch('/members'),
                    getMemberDetails: (userId) => this.api.fetch(`/members/${userId}`),
                    getMemberStats: (userId) => this.api.fetch(`/members/${userId}/stats`),
                    addObservation: (userId, data) => this.api.fetch(`/members/${userId}/observations`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }),
                    updateRegistro: (pontoId, data) => this.api.fetch(`/registros/${pontoId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }),
                    deleteRegistro: (pontoId) => this.api.fetch(`/registros/${pontoId}`, { method: 'DELETE' }),
                };
            }

            defineTemplates() {
                this.templates = {
                    // ... (todos os outros templates)
                    appShell: (user) => `<div class="flex h-screen"><aside class="sidebar w-64 flex-shrink-0 flex flex-col border-r transition-all" style="background-color: var(--sidebar-bg); border-color: var(--border-color);"><div class="h-16 flex items-center justify-center px-4 border-b border-inherit"><h1 class="text-xl font-bold text-blue-500 flex items-center gap-2"><i class="fas fa-shield-alt"></i><span>PAINEL SSP</span></h1></div><nav class="flex-1 px-4 py-6 space-y-1.5" id="main-nav"><a href="#members" class="nav-link flex items-center px-4 py-2.5 rounded-lg text-sm font-semibold transition-colors"><i class="fas fa-users w-6 mr-3 text-center"></i>Membros</a></nav><div class="p-4 border-t border-inherit"><div class="text-right"><div class="font-semibold text-sm">${user.name}</div><div class="text-xs text-text-secondary">${user.email}</div></div></div></aside><main class="flex-1 flex flex-col overflow-hidden"><header class="h-16 flex items-center justify-between px-6 border-b border-inherit flex-shrink-0 bg-[var(--card-bg)]/80 backdrop-blur-sm"><h2 id="page-title" class="text-2xl font-bold"></h2><button id="theme-toggle" class="text-slate-500 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-full w-10 h-10 flex items-center justify-center transition-colors"></button></header><div id="page-content" class="flex-1 overflow-y-auto p-6 page-fade-in"></div></main></div>`,
                    membersPage: () => `
                        <div class="card rounded-xl shadow-lg border-0" style="background-color: var(--card-bg);">
                            <div class="p-6 border-b border-inherit flex flex-col md:flex-row justify-between items-center gap-4">
                                <div><h3 class="text-xl font-bold">Membros por Batalhão</h3><p class="text-sm text-text-secondary">Lista de membros agrupados e ordenados por hierarquia.</p></div>
                                <div class="relative w-full md:w-auto"><i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-text-secondary"></i><input type="text" id="member-search-input" placeholder="Buscar membro ou ID..." class="w-full md:w-64 pl-10 pr-4 py-2 bg-slate-100 dark:bg-slate-800 border-transparent rounded-lg"></div>
                            </div>
                            <div id="members-accordion-container" class="p-4 space-y-2"></div>
                        </div>`,
                    battalionAccordion: (group, isColorDark) => `
                        <div class="border border-border-color rounded-lg">
                            <button class="accordion-header w-full flex justify-between items-center text-left p-4 font-bold text-lg hover:bg-slate-500/10 transition-colors">
                                <span>${group.batalhaoName} (${group.members.length})</span>
                                <i class="fas fa-chevron-down transition-transform duration-300"></i>
                            </button>
                            <div class="accordion-content">
                                <div class="overflow-x-auto">
                                    <table class="min-w-full text-sm">
                                        <thead class="text-xs text-text-secondary uppercase bg-slate-50 dark:bg-slate-800/50">
                                            <tr>
                                                <th class="px-6 py-3 text-left font-semibold">Membro</th>
                                                <th class="px-6 py-3 text-left font-semibold">Cargos</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-border-color">
                                            ${group.members.length > 0 ? group.members.map(m => `
                                                <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/60">
                                                    <td class="p-4 px-6">
                                                        <div class="flex items-center gap-4">
                                                            <img src="${m.avatarUrl || 'https://cdn.discordapp.com/embed/avatars/0.png'}" alt="Avatar" class="w-10 h-10 rounded-full">
                                                            <div>
                                                                <div class="font-semibold">${m.username}</div>
                                                                <div class="text-xs text-text-secondary">${m.discordUserId}</div>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td class="p-4 px-6">
                                                        <div class="flex flex-wrap gap-2">
                                                            ${m.roles.length > 0 ? m.roles.map(role => `<span class="text-xs font-semibold px-2 py-1 rounded-full" style="background-color: ${role.color || '#99aab5'}; color: ${isColorDark(role.color || '#99aab5') ? '#FFF' : '#000'};">${role.name}</span>`).join('') : '<span class="text-xs text-text-secondary italic">Nenhum cargo.</span>'}
                                                        </div>
                                                    </td>
                                                </tr>
                                            `).join('') : '<tr><td colspan="2" class="text-center p-8 text-text-secondary italic">Nenhum membro encontrado neste batalhão.</td></tr>'}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>`,
                    errorPage: (message) => `<div class="text-center p-16"><i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i><h1 class="text-2xl font-bold">Ocorreu um Erro</h1><p class="text-text-secondary">${message}</p></div>`,
                    notFoundPage: () => `<div class="text-center p-16"><h1 class="text-4xl font-bold">404</h1><p class="text-text-secondary">Página não encontrada.</p></div>`,
                };
            }
        }
        new GcmPanelApp(document.getElementById('app-root'));
    </script>
</body>
</html>